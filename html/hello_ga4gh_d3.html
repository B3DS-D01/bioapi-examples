<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link { stroke: white; }
.nodetext {
	font-size: 6pt;
  fill: white;
  pointer-events: none; font: 10px sans-serif; stroke-width: auto;}


html, body, svg {
  background-color: black;
}
div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 60px;					
    height: 28px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}
</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>
var i = 0;
// make a list of the gene names by doing a search on gene type

// make a pull down to visualize the tree of a gene

function loadpage(page){
  d3.json("http://1kgenomes.ga4gh.org/features/search")
      .header("Content-Type", "application/json")
	.post(JSON.stringify({featureSetId: "WyIxa2dlbm9tZXMiLCJnZW5jb2RlX3YyNGxpZnQzNyJd",
    pageToken: page,
    geneSymbol: "BRCA1",
    featureTypes: [],
    pageSize: 50}),
        function(error, data) {
          // request next page
          i++;
          data.features.forEach(addNode);
          addLinks(data.features);
          if (data.nextPageToken && i < 30) {
            loadpage(data.nextPageToken)
          } else {
            console.log('done');
          }
      });
}

loadpage()


var nbyid = {};
function nodeById(nid) {
  return nbyid[nid];
}
var edges = {};
function addEdge(edge){
  var n = nbyid[edge.source];
  var t= nodeById(edge.target);
  if (t !== undefined) {
    edges[n.id + "-" + nodeById(edge.source).id] = true;
    links.push({source: n.index, target: nodeById(edge.target).index});
  }
}

function addLinks(features) {
  nodes.forEach(function(feature){
    feature.childIds.forEach(function(cid){
      addEdge({source: feature.id, target: cid})
    })
  })
}

function addNode(node){
  // console.log("adding node")
  // console.log(node.id)
  nbyid[node.id] = node
  nodes.push(node);
  start()
}

var width = window.innerWidth,
    height = window.innerHeight;

var color = d3.scale.category10();

var nodes = [],
    links = [];

var force = d3.layout.force()
    .nodes(nodes)
    .links(links)
    .gravity(5)
    .charge(-300)
    .linkDistance(10)
    .linkStrength(2)
    .chargeDistance(500)
    .size([width, height])
    .on("tick", tick);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var node = svg.selectAll(".node"),
    link = svg.selectAll(".link");


function start() {
  var colors = d3.scale.category10();
  colors.domain(['UTR', 'exon', 'transcript', 'stop_codon', 'CDS', 'gene'])
  link = link.data(force.links(), function(d) { return d.source.id + "-" + d.target.id; });
  link.enter().insert("line", ".link").attr("class", "link");
  link.exit().remove();

  node = node.data(force.nodes(), function(d) { return d.id + Math.random();});
  node
    .enter()
    .append("g")
    .attr("class", "node")

  node.append("circle")
    .attr("r", function(d) {
      if (d.featureType.term == 'gene') {
        return 10
      } else {
        return 3
      }
    })
  .style('fill', function(d) {
    return colors(d.featureType.term)
  }).on("mouseup", function(d) {
    console.log(d);
  })
  
  node.exit().remove();

  force.start();
}

function tick() {
  node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  link.attr("x1", function(d) { return d.source.x })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
}

</script>